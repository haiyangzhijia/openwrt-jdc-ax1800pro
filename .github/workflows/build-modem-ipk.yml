name: Build luci-app-modem IPK

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"

    - name: Clone source code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        
    - name: Update feeds
      run: |
        cd openwrt
        # Add Siriling feed
        echo 'src-git siriling https://github.com/Siriling/5G-Modem-Support.git' >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure for IPK build
      run: |
        cd openwrt
        # Set target to Qualcomm/Atheros IPQ60xx (JDCloud AX1800 Pro architecture)
        echo "CONFIG_TARGET_qualcommax=y" > .config
        echo "CONFIG_TARGET_qualcommax_ipq60xx=y" >> .config
        echo "CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_jdcloud_re-ss-01=y" >> .config
        
        # Select luci-app-modem and its dependencies as modules (M)
        echo "CONFIG_PACKAGE_luci-app-modem=m" >> .config
        echo "CONFIG_PACKAGE_quectel-cm=m" >> .config
        echo "CONFIG_PACKAGE_sms-tool=m" >> .config
        
        # Expand full config
        make defconfig

    - name: Compile luci-app-modem
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        # Compile only the package and its deps
        make package/luci-app-modem/compile V=s

    - name: Organize IPK files
      run: |
        mkdir -p ipk_output
        find openwrt/bin/packages -name "luci-app-modem*.ipk" -exec cp {} ipk_output/ \;
        find openwrt/bin/packages -name "quectel-cm*.ipk" -exec cp {} ipk_output/ \;
        find openwrt/bin/packages -name "sms-tool*.ipk" -exec cp {} ipk_output/ \;

    - name: Upload IPK
      uses: actions/upload-artifact@main
      with:
        name: luci-app-modem-ipk
        path: ipk_output/
